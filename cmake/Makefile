###############################################################################
# Makefile for Embedded Wizard GUI Application
###############################################################################
export MAKEFLAGS += --silent

###############################################################################
# GENERAL PROJECT CONFIGURATION
###############################################################################
APP_FILE          = MotorControlHMI

FREE_RTOS        ?= 1
# REMARK: Set the macro FREE_RTOS to 1 to build an Embedded Wizard project
# based on FreeRTOS.

###############################################################################
# GENERAL SETTINGS & PATHS
###############################################################################
EMWI_APP_PATH     = ../Application/EmbeddedWizardGeneratedCode

SRC_PATH          = ../Application/Source
EMWI_BSP_PATH     = ../Submodules/TargetSpecific

OBJ_PATH          = ./Obj
BIN_PATH          = ./Bin

SDK_PATH          = ../Submodules/ThirdParty/STM32Cube_FW_H7
DRIVERS_PATH      = $(SDK_PATH)/Drivers
FREE_RTOS_PATH    = $(SDK_PATH)/Middlewares/Third_Party/FreeRTOS
STARTUP           = ./startup_stm32h7b3xx.s
LINK_SCRIPT       = ./stm32h7xx_flash.ld

ifeq ($(FREE_RTOS),1)
FREE_RTOS_SOURCE_PATH =                                                        \
                    $(FREE_RTOS_PATH)/Source                                   \
                    $(FREE_RTOS_PATH)/Source/CMSIS_RTOS                        \
                    $(FREE_RTOS_PATH)/Source/portable/MemMang                  \
                    $(FREE_RTOS_PATH)/Source/portable/GCC/ARM_CM7/r0p1
endif

###############################################################################
# Include standard rules and utilities
# Include Embedded Wizard configuration and list of generated source code
###############################################################################
include ./utilities.mk
include ./rules.mk

ifeq (,$(wildcard $(EMWI_APP_PATH)/ewfiles.inc))
  $(error ERROR: $n$nThe file '(EMWI_APP_PATH)/ewfiles.inc' is missing!\
    $nPlease open Embedded Wizard project and generate code before calling make!)
endif

include $(EMWI_APP_PATH)/ewfiles.inc

EMWI_RTE_PATH     = ../Submodules/PlatformPackage/RTE
EMWI_GFX_PATH     = ../Submodules/PlatformPackage/$(EMWI_COLOR_FORMAT)

include $(EMWI_GFX_PATH)/ewgfx.inc
include $(EMWI_RTE_PATH)/ewrte.inc

###############################################################################
# Standard directories for C files
###############################################################################
vpath %.c           $(SRC_PATH)                                                \
                    $(EMWI_APP_PATH)                                           \
                    $(EMWI_RTE_PATH)                                           \
                    $(EMWI_GFX_PATH)                                           \
                    $(EMWI_BSP_PATH)                                           \
                    $(EMWI_BSP_PATH)/Drivers                                   \
                    $(DRIVERS_PATH)/STM32H7xx_HAL_Driver/src                   \
                    $(DRIVERS_PATH)/BSP/STM32H7B3I-DK                          \
                    $(DRIVERS_PATH)/BSP/Components/is42s16800j                 \
                    $(DRIVERS_PATH)/BSP/Components/mx25lm51245g                \
                    $(FREE_RTOS_SOURCE_PATH)

###############################################################################
# SOURCES
###############################################################################
APP_C =                                                                        \
                    main.c                                                     \
                    ewmain.c                                                   \
                    DeviceDriver.c                                             \

# automatically compile all files generated by Embedded Wizard
APP_EMWI_C =        $(EMWIFILES)

# compile all files for the Embedded Wizard Runtime Environment (RTE)
RTE_EMWI_C =        $(EMWI_RTE_FILES)

# compile all files for the Embedded Wizard Graphics Engine (GFX)
GFX_EMWI_C =        $(EMWI_GFX_FILES)

BOARD_CONFIG_C =                                                               \
                    ew_bsp_os.c                                                \
                    ew_bsp_system.c                                            \
                    ew_bsp_clock.c                                             \
                    ew_bsp_event.c                                             \
                    ew_bsp_display.c                                           \
                    ew_bsp_touch.c                                             \
                    ew_bsp_console.c                                           \
                    ew_bsp_inout.c                                             \
                    ew_bsp_graphics.c                                          \
                    stm32h7xx_it.c                                             \
                    system_stm32h7xx.c                                         \

BSP_C =                                                                        \
                    stm32h7xx_hal.c                                            \
                    stm32h7xx_hal_adc.c                                        \
                    stm32h7xx_hal_adc_ex.c                                     \
                    stm32h7xx_hal_rcc.c                                        \
                    stm32h7xx_hal_rcc_ex.c                                     \
                    stm32h7xx_hal_cortex.c                                     \
                    stm32h7xx_hal_gpio.c                                       \
                    stm32h7xx_hal_sdram.c                                      \
                    stm32h7xx_hal_dma.c                                        \
                    stm32h7xx_hal_ltdc.c                                       \
                    stm32h7xx_hal_mdma.c                                       \
                    stm32h7xx_hal_dma2d.c                                      \
                    stm32h7xx_hal_i2c.c                                        \
                    stm32h7xx_hal_i2c_ex.c                                     \
                    stm32h7xx_ll_fmc.c                                         \
                    stm32h7xx_hal_uart.c                                       \
                    stm32h7xx_hal_uart_ex.c                                    \
                    stm32h7xx_hal_pwr.c                                        \
                    stm32h7xx_hal_pwr_ex.c                                     \
                    stm32h7xx_hal_exti.c                                       \
                    stm32h7xx_hal_rtc.c                                        \
                    stm32h7xx_hal_rtc_ex.c                                     \
                    stm32h7xx_hal_ospi.c                                       \
                    \
                    ft5336.c                                                   \
                    ft5336_reg.c                                               \
                    is42s16800j.c                                              \
                    mx25lm51245g.c                                             \
                    \
                    stm32h7b3i_discovery.c                                     \
                    stm32h7b3i_discovery_sdram.c                               \
                    stm32h7b3i_discovery_ts.c                                  \
                    stm32h7b3i_discovery_bus.c                                 \
                    stm32h7b3i_discovery_ospi.c                                \

FREE_RTOS_C =                                                                  \
                    list.c                                                     \
                    queue.c                                                    \
                    tasks.c                                                    \
                    timers.c                                                   \
                    cmsis_os.c                                                 \
                    heap_4.c                                                   \
                    port.c                                                     \

###############################################################################
# LIBRARIES
###############################################################################
LIBS :=             m                                                          \
                    c                                                          \
                    nosys                                                      \
                    $(EMWI_GFX_LIB)                                            \
                    $(EMWI_RTE_LIB)                                            \

###############################################################################
# INCLUDES
###############################################################################
INCLUDES =                                                                     \
                    -I$(SRC_PATH)                                              \
                    -I$(EMWI_BSP_PATH)                                         \
                    -I$(EMWI_BSP_PATH)/Drivers                                 \
                    -I$(EMWI_APP_PATH)                                         \
                    -I$(EMWI_RTE_PATH)                                         \
                    -I$(EMWI_GFX_PATH)                                         \
                    -I$(DRIVERS_PATH)/CMSIS/Device/ST/STM32H7xx/Include        \
                    -I$(DRIVERS_PATH)/CMSIS/Include                            \
                    -I$(DRIVERS_PATH)/STM32H7xx_HAL_Driver/Inc                 \
                    -I$(DRIVERS_PATH)/BSP/STM32H7B3I-DK                        \
                    -I$(DRIVERS_PATH)/BSP/Components/Common                    \

ifeq ($(FREE_RTOS),1)
INCLUDES +=                                                                    \
                    -I$(FREE_RTOS_PATH)/Source/portable/GCC/ARM_CM7/r0p1       \
                    -I$(FREE_RTOS_PATH)/Source/CMSIS_RTOS                      \
                    -I$(FREE_RTOS_PATH)/Source/include
endif

###############################################################################
# DEFINES
###############################################################################
CFLAGS =            -O2 -Wall -mcpu=cortex-m7 -mlittle-endian -mthumb          \
                    -mthumb-interwork -mfpu=fpv5-d16 -mfloat-abi=hard          \
                    -ffunction-sections -fdata-sections                        \
                    -DUSE_HAL_DRIVER                                           \
                    -DUSE_STM32H7B3I_DISCOVERY                                 \
                    -DSTM32H7B3xxQ                                             \
                    -DEW_FRAME_BUFFER_COLOR_FORMAT=EW_FRAME_BUFFER_COLOR_FORMAT_$(EMWI_COLOR_FORMAT) \
                    -DEW_SURFACE_ROTATION=$(EMWI_SURFACE_ROTATION)             \
                    -DEW_USE_OPERATING_SYSTEM=$(FREE_RTOS)                     \

###############################################################################
# OBJECTS
###############################################################################
APP_OBJ           := $(foreach file,$(APP_C),             $(OBJ_PATH)/$(strip $(basename $(file))).o)
APP_EMWI_OBJ      := $(foreach file,$(APP_EMWI_C),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
RTE_EMWI_OBJ      := $(foreach file,$(RTE_EMWI_C),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
GFX_EMWI_OBJ      := $(foreach file,$(GFX_EMWI_C),        $(OBJ_PATH)/$(strip $(basename $(file))).o)
BOARD_CONFIG_OBJ  := $(foreach file,$(BOARD_CONFIG_C),    $(OBJ_PATH)/$(strip $(basename $(file))).o)
BSP_OBJ           := $(foreach file,$(BSP_C),             $(OBJ_PATH)/$(strip $(basename $(file))).o)

ifeq ($(FREE_RTOS),1)
FREE_RTOS_OBJ     := $(foreach file,$(FREE_RTOS_C),       $(OBJ_PATH)/$(strip $(basename $(file))).o)
endif

OBJS := $(APP_OBJ) $(APP_EMWI_OBJ) $(RTE_EMWI_OBJ) $(GFX_EMWI_OBJ) $(BOARD_CONFIG_OBJ) $(BSP_OBJ) $(FREE_RTOS_OBJ)

MAPFILE   = -Wl,-Map=$(BIN_PATH)/$(APP_FILE).map

LINKING   = $(LD) -mcpu=cortex-m7 -mlittle-endian -mthumb -mthumb-interwork    \
            -mfpu=fpv5-d16 -mfloat-abi=hard -Wl,--gc-sections                  \
            $(MAPFILE)                                                         \
            $(STARTUP)                                                         \
            $(OBJS)                                                            \
            $(addprefix -L,$(EMWI_RTE_PATH))                                   \
            $(addprefix -L,$(EMWI_GFX_PATH))                                   \
            $(addprefix -l,$(LIBS))                                            \
            -T $(LINK_SCRIPT)                                                  \
            -o $(BIN_PATH)/$(APP_FILE).elf

TRANSLATE = $(OBJCOPY) -O ihex $(BIN_PATH)/$(APP_FILE).elf $(BIN_PATH)/$(APP_FILE).hex

FLASHING  = ..\..\FlashDownload\FlashDownload.cmd $(BIN_PATH)/$(APP_FILE).hex

PRINT_SIZE = $(SIZE) $(BIN_PATH)/$(APP_FILE).elf

###############################################################################
# RULES
###############################################################################
$(APP_FILE): precompile $(OBJS)
	@echo Linking $(APP_FILE)
	@echo $(LINKING)
	$(LINKING)
	@echo Memory Usage:
	$(PRINT_SIZE)
	$(TRANSLATE)
	@echo $(APP_FILE) successfully built !!

install: $(APP_FILE)
	$(FLASHING)

projectecho:
	@echo -------------------------------------------------
	@echo Creating $(APP_FILE)
	@echo -------------------------------------------------
	@echo Compiler Options: $(CFLAGS)

createdirs:
	@echo -------------------------------------------------
	@echo Creating object and binary directories
	-$(MKDIR) $(OBJ_PATH)
	-$(MKDIR) $(BIN_PATH)
	@echo -------------------------------------------------

precompile: projectecho createdirs ;

clean:
	@echo Cleaning $(OBJ_PATH) and $(BIN_PATH)
	-$(RMDIR) $(OBJ_PATH)
	-$(RMDIR) $(BIN_PATH)

include $(wildcard $(patsubst %,%.d,$(basename $(OBJS))))
